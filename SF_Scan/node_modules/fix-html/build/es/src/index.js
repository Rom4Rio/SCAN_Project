import { win } from "win-doc";
import callfunc from "call-func";
import { htmlDecode } from "html-entity-js";
var allAttr = JSON.parse("[\n\"accept\", \"accept-charset\", \"accesskey\", \"action\", \"allowfullscreen\", \"allowtransparency\", \"align\", \"alt\", \"async\", \"autocomplete\", \"autofocus\", \"autoplay\", \"autocorrect\", \"aria-*\", \n\"border\",\n\"capture\", \"cellpadding\",  \"cellspacing\", \"charset\", \"challenge\", \"checked\", \"class\", \"cols\", \"colspan\", \"content\", \"contenteditable\", \"contextmenu\", \"controls\", \"coords\", \"crossorigin\",\n\"data-*\", \"datetime\", \"defer\", \"dir\", \"disabled\", \"download\", \"draggable\",\n\"enctype\",\n\"for\", \"form\", \"formaction\", \"formenctype\", \"formmethod\", \"formnovalidate\", \"formtarget\", \"frameborder\",\n\"headers\", \"height\", \"hidden\", \"high\", \"href\", \"hreflang\", \"http-equiv\",\n\"item*\", \"icon\", \"id\", \"inputmode\",\n\"js*\",\n\"keyparams\", \"keytype\",\n\"label\", \"lang\", \"list\", \"loop\", \"low\",\n\"manifest\", \"marginheight\", \"marginwidth\", \"max\", \"maxlength\", \"media\", \"method\", \"min\", \"minlength\", \"multiple\", \"muted\",\n\"name\", \"novalidate\", \"nonce\",\n\"open\", \"optimum\",\n\"pattern\", \"placeholder\", \"ping\", \"poster\", \"preload\",\n\"radiogroup\", \"readonly\", \"rel\", \"required\", \"role\", \"rows\", \"rowspan\",\n\"sandbox\", \"scope\", \"scoped\", \"scrolling\", \"seamless\", \"selected\", \"shape\", \"size\", \"sizes\", \"span\", \"spellcheck\", \"src\", \"srcdoc\", \"srcset\", \"start\", \"step\", \"style\", \"summary\",\n\"tabIndex\", \"target\", \"title\", \"type\",\n\"usemap\",\n\"value\",\n\"width\", \"wmode\", \"wrap\",\n\n\"clip-path\", \"cx\", \"cy\",\n\"d\", \"dx\", \"dy\",\n\"fill\", \"fill-opacity\", \"focusable\", \"font-family\", \"font-size\", \"fx\", \"fy\",\n\"gradientTransform\", \"gradientUnits\",\n\"marker-end\", \"marker-mid\", \"marker-start\",\n\"offset\", \"opacity\",\n\"patternContentUnits\", \"patternUnits\", \"points\", \"preserveAspectRatio\",\n\"r\", \"rx\", \"ry\",\n\"spreadMethod\",\n\"stop-color\", \"stop-opacity\",\n\"stroke\", \"stroke-dasharray\", \"stroke-linecap\", \"stroke-opacity\", \"stroke-width\",\n\"text-anchor\", \"transform\",\n\"version\", \"viewBox\",\n\"x1\", \"x2\", \"x\",\n\"xlink:actuate\", \"xlink:arcrole\", \"xlink:href\", \"xlink:role\", \"xlink:show\", \"xlink:title\", \"xlink:type\",\n\"xmlns\", \"xmlns:v\", \"xmlns:o\", \"xml:base\", \"xml:lang\", \"xml:space\",\n\"y1\", \"y2\", \"y\"\n]");
var docTypeReg = /^<!DOCTYPE .*?>/i;

var fixHtml = function fixHtml(s, cb, componentOnly) {
  var d = new (win().DOMParser)();
  var oXml = new (win().XMLSerializer)();
  var domObj = d.parseFromString(s || "", "text/html");
  var xmlStr = componentOnly ? domObj.body.innerHTML : oXml.serializeToString(domObj);
  var docType = (xmlStr.match(docTypeReg) || [])[0] || "";

  var callcb = function callcb(s) {
    return docType + callfunc(cb, [s, {
      allowedTags: false,
      allowedAttributes: {
        "*": allAttr
      }
    }]);
  };

  return htmlDecode(cb ? callcb(xmlStr) : xmlStr);
};

export default fixHtml;